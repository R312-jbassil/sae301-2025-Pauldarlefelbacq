---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Générateur IA">
	<div class="min-h-screen bg-[#F5F5F5] pt-34 pb-12">
		<div class="max-w-5xl mx-auto px-6">
			
			<div class="text-center mb-12">
				<h1 class="text-4xl font-bold text-grisA mb-3">Générateur de Lunettes IA</h1>
				<p class="text-gris text-lg">Décrivez vos lunettes idéales et l'IA créera un design SVG unique</p>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
				
				<!-- Zone de saisie -->
				<div class="bg-blanc p-8 rounded-lg shadow-md">
					<label for="user-prompt" class="block text-grisA font-semibold mb-3">
						Votre description
					</label>
					<textarea 
						id="user-prompt" 
						rows="6"
						class="textarea textarea-bordered w-full bg-blanc border-gris text-grisA mb-6 resize-none"
						placeholder="Ex: Des lunettes de soleil rondes avec des branches dorées et des verres fumés..."
					></textarea>
					
					<button 
						id="generate-button"
						class="btn btn-neutral w-full bg-grisA text-blanc hover:bg-gris transition-colors"
					>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
						</svg>
						Générer
					</button>

					<div id="loading" class="hidden mt-6 text-center">
						<span class="loading loading-spinner loading-lg text-grisA"></span>
						<p class="text-gris mt-3">Génération en cours...</p>
					</div>
				</div>

				<!-- Zone d'affichage SVG -->
				<div class="bg-blanc p-8 rounded-lg shadow-md">
					<h3 class="text-grisA font-semibold mb-4">Résultat</h3>
					<div id="svg-container" class="border-2 border-gris rounded-lg p-8 mb-4 min-h-[300px] flex items-center justify-center bg-[#FAFAFA]">
						<p class="text-gris text-center">Votre design apparaîtra ici</p>
					</div>
					
					<details class="collapse collapse-arrow bg-[#F5F5F5]">
						<summary class="collapse-title text-sm font-medium text-grisA">Code SVG</summary>
						<div class="collapse-content">
							<pre id="svg-output" class="text-xs text-gris overflow-x-auto p-3 bg-blanc rounded mt-2">Aucun code généré</pre>
						</div>
					</details>
				</div>

			</div>
		</div>
	</div>
</Layout>

<script>
	//@ts-nocheck
	
	async function generateSVG(prompt) {
		const res = await fetch('/apis/generate-svg', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ prompt }),
		});
		const data = await res.json();
		
		console.log('[Client] Response:', data);
		
		if (data.error) {
			throw new Error(data.error);
		}
		
		return data.svg;
	}

	async function handleSubmit() {
		const promptElement = document.getElementById("user-prompt");
		const prompt = promptElement?.value?.trim();
		
		if (!prompt) {
			alert('Veuillez entrer une description');
			return;
		}

		const generateButton = document.getElementById("generate-button");
		const loading = document.getElementById("loading");
		const svgContainer = document.getElementById("svg-container");
		const svgOutput = document.getElementById("svg-output");
		
		generateButton.disabled = true;
		loading.classList.remove('hidden');
		svgContainer.innerHTML = '<p class="text-gris">Génération en cours...</p>';
		
		try {
			const svgCode = await generateSVG(prompt);
			
			if (svgCode) {
				svgOutput.textContent = svgCode;
				svgContainer.innerHTML = svgCode;
			} else {
				svgContainer.innerHTML = '<p class="text-error">Erreur: Aucun SVG généré</p>';
			}
		} catch (error) {
			console.error('Error:', error);
			svgContainer.innerHTML = `<p class="text-error">Erreur: ${error.message}</p>`;
		} finally {
			generateButton.disabled = false;
			loading.classList.add('hidden');
		}
	}

	const generateButton = document.getElementById("generate-button");
	if (generateButton) {
		generateButton.addEventListener("click", handleSubmit);
	}

	const promptElement = document.getElementById("user-prompt");
	if (promptElement) {
		promptElement.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && e.ctrlKey) {
				handleSubmit();
			}
		});
	}
</script>