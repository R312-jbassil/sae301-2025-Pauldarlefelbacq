---
import CustomisationLunettes from './CustomisationLunettes.astro';

interface Props {
  glasses: any;
}

const { glasses } = Astro.props;

if (!glasses) {
  throw new Error('CardLunetteModif: glasses prop is required');
}

let montureColor = '#ffffff';
let branchesColor = '#ffffff';

if (glasses?.code_SVG) {
  const parts = glasses.code_SVG.split(',');
  parts.forEach((part: string) => {
    if (part.startsWith('monture:')) {
      montureColor = part.split(':')[1];
    } else if (part.startsWith('branches:')) {
      branchesColor = part.split(':')[1];
    }
  });
}

if (glasses?.monture) montureColor = glasses.monture;
if (glasses?.branches) branchesColor = glasses.branches;

const lensColors: Record<string, string> = {
  'claire': 'transparent',
  'solaire': '#2C2C2C',
  'lumiere-bleue': '#E6F3FF',
  'progressif': '#F0F0F0',
  'anti-reflet': '#FFFACD',
  'photochromique': '#D8BFD8'
};

const verresColor = glasses?.verres ? (lensColors[glasses.verres] || 'transparent') : 'transparent';

const montureMaterial = glasses.expand?.id_mat_m?.libelle_mat_m?.toLowerCase() || '';
const branchesMaterial = glasses.expand?.id_mat_b?.libelle_mat_b?.toLowerCase() || '';
---

<div class="flex flex-col flex-wrap glasses-card bg-blanc p-2  shadow-md hover:shadow-lg transition-shadow"
     data-monture-material={montureMaterial}
     data-branches-material={branchesMaterial}>
  {glasses.Nom && (
    <h3 class="text-lg font-bold text-grisA mb-2">{glasses.Nom}</h3>
  )}
  {glasses.prix && (
    <p class="text-xl font-bold text-vert">{glasses.prix}€</p>
  )}
  
  <div class="preview">
    <CustomisationLunettes 
      montureColor={montureColor}
      brancheColor={branchesColor}
      verresColor={verresColor}
      className="w-full h-auto my-10 card-glasses-svg"
    />
  </div>
  
  <div class="info space-y-2 text-grisA">
    <div class="flex justify-between items-center">
      <span class="font-semibold">Monture:</span>
      <div class="flex items-center gap-2">
        <div 
          class="w-6 h-6 rounded border border-gris monture-preview" 
          style={`background-color: ${montureColor}`}
          data-material={montureMaterial}
        ></div>
        <span class="text-sm">{glasses.expand?.id_mat_m?.libelle_mat_m || 'N/A'}</span>
      </div>
    </div>
    
    <div class="flex justify-between items-center">
      <span class="font-semibold">Branches:</span>
      <div class="flex items-center gap-2">
        <div 
          class="w-6 h-6 rounded border border-gris branches-preview" 
          style={`background-color: ${branchesColor}`}
          data-material={branchesMaterial}
        ></div>
        <span class="text-sm">{glasses.expand?.id_mat_b?.libelle_mat_b || 'N/A'}</span>
      </div>
    </div>
    
    {glasses.verres && (
      <div class="flex justify-between items-center">
        <span class="font-semibold">Verres:</span>
        <span class="text-xs sm:text-sm capitalize truncate max-w-[120px]">{glasses.verres}</span>
      </div>
    )}
    
    {glasses.largeur_pont && (
      <div class="flex justify-between items-center">
        <span class="font-semibold">Pont:</span>
        <span class="text-xs sm:text-sm">{glasses.largeur_pont}mm</span>
      </div>
    )}
    
    <div class="text-xs text-gris mt-2">
      Créé le {new Date(glasses.created).toLocaleDateString('fr-FR')}
    </div>
  </div>

  <div class="actions mt-4 flex gap-2">
    <a 
      href={`/configurateur?id=${glasses.id}`}
      class="btn btn-sm bg-vert text-blanc hover:bg-grisA flex-1 rounded-xs"
    >
      Modifier
    </a>
    <button 
      class="btn btn-sm bg-error text-blanc hover:bg-error/80 rounded-xs delete-btn"
      data-id={glasses.id}
    >
      Supprimer
    </button>
  </div>
</div>

<script>
  document.querySelectorAll('.glasses-card').forEach(card => {
    const svg = card.querySelector('.card-glasses-svg') as HTMLElement;
    if (!svg) return;
    
    const montureMat = (card as HTMLElement).dataset.montureMaterial || '';
    const branchesMat = (card as HTMLElement).dataset.branchesMaterial || '';
    
    const textureMap: Record<string, string> = {
      'bois': 'url(#texture-bois)',
      'carbone': 'url(#texture-carbone)',
      'or': 'url(#texture-or)'
    };
    
    if (textureMap[montureMat]) {
      svg.style.setProperty('--monture-fill', textureMap[montureMat]);
    }
    
    if (textureMap[branchesMat]) {
      svg.style.setProperty('--branche-fill', textureMap[branchesMat]);
    }
    
    const monturePreview = card.querySelector('.monture-preview') as HTMLElement;
    const branchesPreview = card.querySelector('.branches-preview') as HTMLElement;
    
    if (monturePreview && textureMap[montureMat]) {
      monturePreview.style.background = textureMap[montureMat];
      monturePreview.style.backgroundSize = 'cover';
    }
    
    if (branchesPreview && textureMap[branchesMat]) {
      branchesPreview.style.background = textureMap[branchesMat];
      branchesPreview.style.backgroundSize = 'cover';
    }
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement;
      const id = target.dataset.id;
      
      if (!confirm('Êtes-vous sûr de vouloir supprimer ces lunettes ?')) return;

      try {
        const response = await fetch(`/apis/lunettes/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Erreur lors de la suppression');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion');
      }
    });
  });
</script>
