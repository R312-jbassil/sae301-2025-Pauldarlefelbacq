# name: Build and Deploy to VPS

# on:
#   push:
#     branches: [main]
  
# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '18'
#           cache: 'npm'
        
#       - name: Install dependencies
#         run: npm ci
        
#       - name: Build project
#         run: |
#           npm run build
#           cp package.json dist/server/
      
#       - name: Deploy to VPS via SCP
#         uses: appleboy/scp-action@v0.1.3
#         with:
#           host: ${{ secrets.HOST }}
#           username: ${{ secrets.USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           port: 22004
#           source: "dist/*"
#           target: "/var/www/SAE301/"
#           strip_components: 1
#           rm: false
#           overwrite: true
#           debug: true
      
#       - name: Install production dependencies on VPS
#         uses: appleboy/ssh-action@v1.0.0
#         with:
#           host: ${{ secrets.HOST }}
#           username: ${{ secrets.USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           port: 22004
#           script: |
#             cd /var/www/SAE301/server
#             npm ci
#             npm install astro
#             npm install send server-destroy
#             if pm2 describe SAE301 > /dev/null 2>&1; then
#               PORT=8089 pm2 restart SAE301 --update-env
#             else
#               PORT=8089 pm2 start dist/server/entry.mjs --name SAE301 --cwd /var/www/SAE301
#             fi
#             pm2 save

name: Deploy to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "dist/*"
          target: "/var/www/SAE301/"
          strip_components: 0
          
      - name: Deploy and restart PM2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /var/www/SAE301
            if pm2 describe SAE301 > /dev/null 2>&1; then
              PORT=8089 pm2 restart SAE301 --update-env
            else
              PORT=8089 pm2 start dist/server/entry.mjs --name SAE301
            fi
            pm2 save
